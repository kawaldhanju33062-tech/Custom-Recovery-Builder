name: Modify Recovery Image

on:
  workflow_dispatch:
    inputs:
      img_url:
        description: 'Link to recovery.img'
        required: true

jobs:
  modify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cpio python3 android-sdk-libsparse-utils file wget tar

      - name: Setup AIK
        run: |
          mkdir AIK
          wget https://github.com/SebaUbuntu/AIK-Linux-Mirror/archive/refs/heads/master.tar.gz -O aik.tar.gz
          tar -xzf aik.tar.gz --strip-components=1 -C AIK
          chmod -R +x AIK/*.sh
          chmod -R +x AIK/bin/*

      - name: Download Recovery
        run: |
          CLEAN_URL=$(echo "${{ github.event.inputs.img_url }}" | sed 's/\.html$//')
          wget --referer="https://dl.twrp.me/" -O recovery_input.img "$CLEAN_URL"
          simg2img recovery_input.img recovery.img || cp recovery_input.img recovery.img

      - name: Unpack Image
        run: |
          cd AIK
          # AIK must run with sudo to handle Android file permissions
          sudo ./unpackimg.sh ../recovery.img

      - name: Make Changes
        run: |
          # Use sudo here to bypass the "Permission denied" error
          sudo touch AIK/ramdisk/modified_by_gemini.txt
          echo "Applied changes to ramdisk with root permissions."

      - name: Repack Image
        run: |
          cd AIK
          # Repack also needs sudo to read the restricted ramdisk files
          sudo ./repackimg.sh
          echo "Checking for output files..."
          ls -lh image-new.img || echo "Image not found yet"

      - name: Upload Resulting Image
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: modified-recovery
          path: AIK/image-new.img
          
