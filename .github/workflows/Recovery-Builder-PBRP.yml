name: Modify Recovery Image

on:
  workflow_dispatch:
    inputs:
      img_url:
        description: 'Link to recovery.img'
        required: true

jobs:
  modify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cpio python3 android-sdk-libsparse-utils file wget tar

      - name: Setup AIK (Linux Binaries)
        run: |
          # Create AIK directory
          mkdir AIK
          # Download a pre-compiled Linux AIK bundle from a reliable source
          wget https://github.com/SebaUbuntu/AIK-Linux-Mirror/archive/refs/heads/master.tar.gz -O aik.tar.gz
          tar -xzf aik.tar.gz --strip-components=1 -C AIK
          # Set permissions
          chmod -R +x AIK/*.sh
          chmod -R +x AIK/bin/*

      - name: Download Recovery
        run: |
          # Clean URL and handle TWRP Referer
          CLEAN_URL=$(echo "${{ github.event.inputs.img_url }}" | sed 's/\.html$//')
          wget --referer="https://dl.twrp.me/" -O recovery_input.img "$CLEAN_URL"
          # Convert sparse to raw if needed
          simg2img recovery_input.img recovery.img || cp recovery_input.img recovery.img

      - name: Unpack Image
        run: |
          cd AIK
          ./unpackimg.sh ../recovery.img

      - name: Make Changes
        run: |
          echo "Current files in ramdisk:"
          ls AIK/ramdisk/
          
          # --- ADD YOUR CUSTOM CHANGES HERE ---
          # Example: To change the recovery theme color or default properties:
          # touch AIK/ramdisk/custom_marker_file 
          # -------------------------------------

      - name: Repack Image
        run: |
          cd AIK
          ./repackimg.sh

      - name: Upload Modified Image
        uses: actions/upload-artifact@v4
        with:
          name: modified-recovery
          path: AIK/image-new.img
          
