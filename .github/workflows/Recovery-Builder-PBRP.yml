name: Modify Recovery Image

on:
  workflow_dispatch:
    inputs:
      img_url:
        description: 'Link to recovery.img'
        required: true

jobs:
  modify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cpio python3 android-sdk-libsparse-utils file wget tar

      - name: Setup AIK
        run: |
          mkdir AIK
          wget https://github.com/SebaUbuntu/AIK-Linux-Mirror/archive/refs/heads/master.tar.gz -O aik.tar.gz
          tar -xzf aik.tar.gz --strip-components=1 -C AIK
          chmod -R +x AIK/*.sh
          chmod -R +x AIK/bin/*

      - name: Download Recovery
        run: |
          CLEAN_URL=$(echo "${{ github.event.inputs.img_url }}" | sed 's/\.html$//')
          wget --referer="https://dl.twrp.me/" -O recovery_input.img "$CLEAN_URL"
          simg2img recovery_input.img recovery.img || cp recovery_input.img recovery.img

      - name: Unpack Image
        run: |
          cd AIK
          ./unpackimg.sh ../recovery.img

      - name: Make Changes
        run: |
          # Add a test file to prove the ramdisk was modified
          touch AIK/ramdisk/modified_by_gemini.txt
          echo "Applied changes to ramdisk."

      - name: Repack Image
        run: |
          cd AIK
          ./repackimg.sh
          echo "Checking for output files..."
          ls -lh  # This will show us the contents of the AIK folder in the logs

      - name: Upload Resulting Image
        if: always() # Upload even if previous steps had warnings
        uses: actions/upload-artifact@v4
        with:
          name: modified-recovery-output
          # We use a wildcard to catch 'image-new.img' or whatever AIK produced
          path: |
            AIK/image-new.img
            AIK/unsigned-new.img
            AIK/split_img/*
            
